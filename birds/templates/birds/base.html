{% load staticfiles %}
<!doctype html>
<!--
  Material Design Lite
  Copyright 2015 Google Inc. All rights reserved.
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
      https://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License
-->
<html lang="en" prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
	{% block desc_title %}
	{% endblock %}
	
	<!-- ICONS -->
    <link rel="shortcut icon" href="{% static "birds/images/favicon-96x96.png" %}">
	
	<link rel="apple-touch-icon" sizes="57x57" href="{% static "birds/images/apple-icon-57x57.png" %}">
	<link rel="apple-touch-icon" sizes="60x60" href="{% static "birds/images/apple-icon-60x60.png" %}">
	<link rel="apple-touch-icon" sizes="72x72" href="{% static "birds/images/apple-icon-72x72.png" %}">
	<link rel="apple-touch-icon" sizes="76x76" href="{% static "birds/images/apple-icon-76x76.png" %}">
	<link rel="apple-touch-icon" sizes="114x114" href="{% static "birds/images/apple-icon-114x114.png" %}">
	<link rel="apple-touch-icon" sizes="120x120" href="{% static "birds/images/apple-icon-120x120.png" %}">
	<link rel="apple-touch-icon" sizes="144x144" href="{% static "birds/images/apple-icon-144x144.png" %}">
	<link rel="apple-touch-icon" sizes="152x152" href="{% static "birds/images/apple-icon-152x152.png" %}">
	<link rel="apple-touch-icon" sizes="180x180" href="{% static "birds/images/apple-icon-180x180.png" %}">
	<link rel="icon" type="image/png" sizes="192x192"  href="{% static "birds/images/android-icon-192x192.png" %}">
	<link rel="icon" type="image/png" sizes="32x32" href="{% static "birds/images/favicon-32x32.png" %}">
	<link rel="icon" type="image/png" sizes="96x96" href="{% static "birds/images/favicon-96x96.png" %}">
	<link rel="icon" type="image/png" sizes="16x16" href="{% static "birds/images/favicon-16x16.png" %}">
	<link rel="manifest" href="{% static "birds/images/manifest.json" %}">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="{% static "birds/images/ms-icon-144x144.png" %}">
	<meta name="theme-color" content="#ffffff">
	
    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="The Birding Book">

    <!-- SEO: If your mobile URL is different from the desktop URL, add a canonical link to the desktop page https://developers.google.com/webmasters/smartphone-sites/feature-phones -->
    <!--
    <link rel="canonical" href="http://www.example.com/">
    -->
    <!--FONT NOTO-->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:regular,bold,italic,thin,light,bolditalic,black,medium&amp;lang=en">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="{% static "birds/style.css" %}">
    <link rel="stylesheet" type="text/css" href="{% static 'birds/jquery-ui-1.11.4.custom/jquery-ui.css' %}" />
    
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?libraries=places&key=AIzaSyDcWjuyosd0o5iQ2am9FFN2IC568p6-VCU&language=en"></script>
    <script src="{% static 'birds/jquery-ui-1.11.4.custom/external/jquery/jquery.js' %}"></script>
    <script src="{% static 'birds/jquery-ui-1.11.4.custom/jquery-ui.js' %}"></script>
	
	<script src="{% static 'birds/js/scripts.js' %}"></script>
	
	<!-- Firebase -->
	<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.6.1/firebase-auth.js"></script>

	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-91303178-1', 'auto');
		ga('send', 'pageview');

	</script>


    <style>
    #view-source {
      position: fixed;
      display: block;
      right: 0;
      bottom: 0;
      margin-right: 40px;
      margin-bottom: 40px;
      z-index: 900;
    }
    </style>
  </head>
  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <header class="mdl-layout__header mdl-color--grey-100 mdl-color-text--grey-100">
        <div class="mdl-layout__header-row mdl-color--blue-grey-900">
			
			
			
			<!--<div id="top-layout-spacer" class="mdl-layout-spacer"></div>-->

			<i class="material-icons">search</i>
			<div class="mdl-tooltip" for="search_icon">
				Species Lookup
			</div>
			<div class="mdl-textfield mdl-js-textfield mdl-color-text--grey-100" style="width:auto">
				<input class="mdl-textfield__input" type="text" id="search_bar">
				<label class="mdl-textfield__label mdl-color-text--grey-400" for="search_bar">Search</label>
				<span class="mdl-textfield__error"></span>
			</div>
			<!--<div class="mdl-textfield mdl-js-textfield mdl-textfield--expandable">
				<label class="mdl-button mdl-js-button mdl-button--icon" for="search_bar" id="location_search_icon">
				  <i class="material-icons">place</i>
				</label>
				<div class="mdl-textfield__expandable-holder">
				  <input class="mdl-textfield__input" type="text" id="search_bar" placeholder="Location">
				</div>
				<div class="mdl-tooltip mdl-tooltip--bottom" for="location_search_icon">
					Search by Location
				</div>
			</div>
			<div id="clear_search_container mdl-color-text--grey-100">
				<label class="mdl-button mdl-js-button mdl-button--icon" id="clear_search_button">
					<i class="material-icons">clear</i>
				</label>
				<div class="mdl-tooltip mdl-tooltip--bottom" for="clear_search_button">
					Clear Search
				</div>
			</div>-->
		  <div id="header-row-spacer" class="mdl-layout-spacer"></div>
		  <!--
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" id="hdrbtn">
            <i class="material-icons">more_vert</i>
          </button>
          <ul class="mdl-menu mdl-js-menu mdl-js-ripple-effect mdl-menu--bottom-right" for="hdrbtn">
            <li class="mdl-menu__item">About</li>
            <li class="mdl-menu__item">Contact</li>
            <li class="mdl-menu__item">Legal information</li>
          </ul>-->

                {% if user.is_authenticated %}
                    <a class="user-ident no-decoration" href="{% url 'birds:user' user.id %}">
						{% if user.avatar %}
							<div class="mdl-shadow--8dp" style="border-radius:25px;height:50px;width:50px;background: url({{ user.avatar.thumbnail_url }}) no-repeat center;background-size:cover;"></div>
						{% else %}
							<i class="material-icons">account_circle</i>
						{% endif %}
						<!--<span style="margin-left:8px; margin-top:16px;"> {{ user.username }}</span>-->
					</a>
                {% else %}
                    <span><a class="mdl-button mdl-js-button mdl-button--accent mdl-color-text--cyan-A100" href="{% url 'login' %}">Sign In</a></span>
                {% endif %}
				
            <button id="accbtn" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
              <i class="material-icons" role="presentation">more_vert</i>
              <span class="visuallyhidden">Accounts</span>
            </button>
            <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="accbtn">
              <a class="mdl-navigation__link" href="{% url 'logout'  %}"><li class="mdl-menu__item"><i class="material-icons">eject</i>Logout</li></a>
            </ul>
        </div>
      </header>
      <div class="demo-drawer mdl-layout__drawer mdl-color--blue-grey-900 mdl-color-text--blue-grey-50">
		<!-- Title -->
		<span class="mdl-layout-title mdl-color--blue-grey-900"><div style="margin:8px;height:96px;width:32px;background: url({% static 'birds/images/feather2.png' %}) no-repeat center;background-size:contain;"></div></span>
        <nav class="demo-navigation mdl-navigation">
          <a class="mdl-color-text--blue-grey-50 mdl-navigation__link" href="{% url 'birds:index' %}"><i class="mdl-color-text--blue-grey-100 material-icons" role="presentation">home</i>Home</a>
          <a class="mdl-color-text--blue-grey-50 mdl-navigation__link" href="{% url 'birds:new_sighting' %}"><i class="mdl-color-text--blue-grey-100 material-icons" role="presentation">add</i>New Sighting</a>
		  <a class="mdl-color-text--blue-grey-50 mdl-navigation__link" href="{% url 'birds:map' %}"><i class="mdl-color-text--blue-grey-100 material-icons" role="presentation">map</i>Map</a>
		  <div class="mdl-layout-spacer"></div>
		  {% if user.is_authenticated %}
		  <a class="mdl-color-text--blue-grey-50 mdl-navigation__link" href="{% url 'birds:feedback' %}"><i class="mdl-color-text--blue-grey-100 material-icons" role="presentation">feedback</i>Feedback</a>
		  {% endif %}
		  <a class="mdl-color-text--blue-grey-50 mdl-navigation__link" href="{% url 'birds:about' %}"><i class="mdl-color-text--blue-grey-100 material-icons" role="presentation">help_outline</i>About</a>
        </nav>
      </div>
		<main class="mdl-layout__content mdl-color--grey-100">
			<div id="page-content">
			{% block content %}{% endblock %}
			</div>
			<div id="snackbar_login_alert" class="mdl-js-snackbar mdl-snackbar">
				<div class="mdl-snackbar__text"></div>
				<button class="mdl-snackbar__action mdl-color-text--cyan-A100" type="button"></button>
			</div>
			<div class="mdl-shadow--2dp" id="search_dialog" style="display:none">
				<div class="mdl-tabs mdl-js-tabs mdl-js-ripple-effect">
					<div class="mdl-tabs__tab-bar">
						<a href="#species-panel" class="mdl-tabs__tab is-active">Species</a>
						<a id="location-panel-tab" href="#location-panel" class="mdl-tabs__tab">Location</a>
						<a href="#user-panel" class="mdl-tabs__tab">User</a>
					</div>

					<div class="mdl-tabs__panel is-active" id="species-panel">
					
					</div>
					<div class="mdl-tabs__panel" id="location-panel">
					
					</div>
					<div class="mdl-tabs__panel" id="user-panel">
					
					</div>
				</div>
			</div>
		</main>
    </div>
		
		<!-- MDL -->
		<script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
		
		
		<!-- base.html functionality -->
		<script type="text/javascript">
		
		var search_org = {
			'species': 0,
			'locations': 0,
			'users': 0
		}
		
		function clear_search( arg ) {
			$.ajax({
				url: "{% url 'birds:update_search' %}",
				data: { 'csrfmiddlewaretoken': '{{ csrf_token }}', 'clear': arg },
				type: "POST",
				dataType: "html",
				success: function(data) {
					if (typeof map === 'undefined') {
						window.location = "{% url 'birds:index' %}";
					}else{
						map_get_data($);
						$('#search_bar').val('').parent().parent().removeClass('is-dirty');
					}
				},
				error: function(jqXHR, textStatus, errorThrown){
					alert(textStatus);
				}
			});
		}
		
		
		jQuery(function($){
			{% if user.is_authenticated %}
				$.ajax({
					url: "{% url 'birds:get_new_notifications_for_user' %}",
					data: { 'csrfmiddlewaretoken': '{{ csrf_token }}' },
					type: "POST",
					dataType: "html",
					success: function(data) {
						$('.mdl-layout__header-row').append(data);
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
			{% endif %}
			
			/*
			function to toggle visible tab on search
			*/
			function toggle_search_viz() {
				if ( search_org['species'] == 0 ) {
					if ( search_org['locations'] > 0 && !$('location-panel').is(':visible') ) {
						$('#location-panel-tab')[0].click();
					}
				}
			}
			
			/*
			hide custom search dialog if open when click off, but keep open when click on search bar
			*/
			$('html').click(function() {
				$('#search_dialog').hide();
			});
			
			$('#search_dialog').click(function(event){
				event.stopPropagation();
			})
			
			$('#search_bar').click(function(event){
				event.stopPropagation();
			}).focus(function(){
				if ( !$('#search_dialog').is(':visible') ) {
					$('#search_dialog').show();
				}
			})
			
			$('#search_bar').autocomplete({
				source: "{% url 'birds:species_query' %}",
				minLength: 1,
				response: function( event, ui ) {
					if ( ui.content.length == 0 ){
						$("ul.ui-autocomplete").hide();
					}
					search_org['species'] = ui.content.length;
				},
				select: function( event, ui ){
				
					//$('#id_species_tag').val(ui.item.id);
					search_bar( ui.item.id );
					
				},
				appendTo: '#species-panel',
				open: function(event, ui) {
					$(".ui-autocomplete").css("position", "relative");
					$(".ui-autocomplete").css("top", "0px");
					$(".ui-autocomplete").css("left", "0px");
				},
				close: function( event, ui ) {
					if (!$("ul.ui-autocomplete").is(":visible")) {
						$("ul.ui-autocomplete").show();
					}
				}
			}).keypress(function(event){
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
					search_bar_text( $(this).val() );
					$( "#search_bar" ).autocomplete( "close" );
				}
			});
			
			function search_bar_text( text_string ){
				$.ajax({
					url: "{% url 'birds:update_search' %}",
					data: { 'csrfmiddlewaretoken': '{{ csrf_token }}', species_text: text_string },
					type: "POST",
					dataType: "json",
					success: function(data) {
						if (typeof map === 'undefined') {
							window.location = "{% url 'birds:index' %}";
						}else{
							map_get_data($);
							//$('#search_bar').val('').blur().parent().parent().removeClass('is-dirty');
						}
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
			}
			
			function search_bar( species_id ) {
				$.ajax({
					url: "{% url 'birds:update_search' %}",
					data: { 'csrfmiddlewaretoken': '{{ csrf_token }}', species_id: species_id },
					type: "POST",
					dataType: "html",
					success: function(data) {
						if (typeof map === 'undefined') {
							window.location = "{% url 'birds:index' %}";
						}else{
							map_get_data($);
							$('#search_bar').val('').blur().parent().parent().removeClass('is-dirty');
						}
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
			}
			
			function search_place( place ) {
				$.ajax({
					url: "{% url 'birds:update_search' %}",
					data: {
						'csrfmiddlewaretoken': '{{ csrf_token }}',
						'location': place.formatted_address,
						'north_lat': place.geometry.location.lat() + 2.0,
						'south_lat': place.geometry.location.lat() - 2.0,
						'east_lng': place.geometry.location.lng() + ( 150 / ( Math.abs(Math.cos(place.geometry.location.lat())) * 69.172 ) ) ,
						'west_lng': place.geometry.location.lng() - ( 150 / ( Math.abs(Math.cos(place.geometry.location.lat())) * 69.172 ) )
					},
					type: "POST",
					dataType: "html",
					success: function(data) {
						if (typeof map === 'undefined') {
							window.location = "{% url 'birds:index' %}";
						}else{
							map_get_data($);
							$('#search_bar').val('').parent().parent().removeClass('is-dirty');
						}
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(textStatus);
					}
				});
			}
			
			/*
			Location Search Box
			*/
			var displaySuggestions = function(predictions, status) {
				if (status != google.maps.places.PlacesServiceStatus.OK) {
					//alert(status);
					return;
				}
				
				search_org['locations'] = predictions.length;
				
				var menu = $('<ul></ul>').addClass('ui-menu ui-widget ui-widget-content');
				$('#location-panel').html(menu);
				
				
				predictions.forEach(function(prediction) {
					var li = $('<li></li>').addClass('ui-menu-item');
					$(li).hover(
						function(){ $(this).addClass('ui-state-hover') },
						function(){ $(this).removeClass('ui-state-hover') }
					);
					$(li).click(function(){
						var service = new google.maps.places.PlacesService(document.createElement('div'));
						service.getDetails({ placeId: prediction.place_id },
							function(place, status) {
								if (status == google.maps.places.PlacesServiceStatus.OK) {
									search_place( place );
								}
							}
						);
					})
					$(li).text(prediction.description);
					$(menu).append(li);
					//alert(prediction.);
				});
				

				
			};

			var service = new google.maps.places.AutocompleteService();
			$('#search_bar').on('input', function(){
				if ( $(this).val() ) {
					service.getPlacePredictions({ input: $(this).val() }, displaySuggestions);
				}
			});
			
		});
		
		{% if not user.is_authenticated %}
		r(function(){
			var snackbarContainer = document.querySelector('#snackbar_login_alert');
			var data = {
				message: 'Login for full functionality',
				timeout: 10000,
				actionHandler: function(){ window.location = "{% url 'login' %}" },
				actionText: 'Login'
			};
			snackbarContainer.MaterialSnackbar.showSnackbar(data);
		});
		function r(f){/in/.test(document.readyState)?setTimeout('r('+f+')',9):f()}
		{% endif %}
		</script>
		
  </body>
</html>
