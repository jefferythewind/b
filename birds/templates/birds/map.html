{% extends 'birds/base.html' %}


{% block content %}

<div id="view" style="height:100%;width:100%;">
	<div id="map"></div>
	<div id="map_details"></div>
</div>

<style type="text/css">

#map {
	height:100%;
	width:100%;
	position:absolute;
}

#map_details {
	
	width:350px;
	position:absolute;
	z-index:2;
	bottom:10px;
	left:10px;
	display: none;
}

</style>
<script type="text/javascript">

var map = new google.maps.Map(document.getElementById('map'), {
	zoom: 2,
	center: { lat: 0, lng: 0 }
});

jQuery(function($){
	features = [];
	
	var featureStyle = {
		icon: {
			path: google.maps.SymbolPath.CIRCLE,
			fillColor: 'red',
			fillOpacity: .5,
			scale: 10,
			strokeColor: 'white',
			strokeWeight: .5
		}
	}
	
	map.data.setStyle(featureStyle);
	
	function fadeInSighting(sighting_id) {
		$.ajax({
			url: "{% url 'birds:info_window' %}",
			data: {'sighting_id': sighting_id, 'csrfmiddlewaretoken': '{{ csrf_token }}'},
			type: "POST",
			dataType: "html",
			success: function(data) {
				$('#map_details').html(data).fadeIn(50);
			}
		});
	}
	
	map.data.addListener('mouseover', function(event){
		fadeInSighting(event.feature.getProperty("sighting_id"));
	});
	
	map.data.addListener('mouseout', function(event) {
		if( !$('#map_details').is(':hover') ) {
			$('#map_details').fadeOut(100);
		
		}else{
			$('#map_details').mouseleave(function(){
				$('#map_details').fadeOut(100);
			});
		}
	});
	
	map.data.addListener('click', function(event)  {
		if (!$('#map_details').is(':visible')){
			fadeInSighting(event.feature.getProperty("sighting_id"));
		}
	});
	
	map.addListener('click', function(){
		if( !$('#map_details').is(':hover') ) {
			$('#map_details').fadeOut(100);
		}
	})
		
	
	var bound_reset_activated = true;
	
	map.addListener('bounds_changed',function(){
		//load points inside these bounds
		if ( bound_reset_activated ) {
			var m = map.getBounds();
			var postData = {
				'north_lat': m.getNorthEast().lat(),
				'south_lat': m.getSouthWest().lat(),
				'east_lng': m.getNorthEast().lng(),
				'west_lng': m.getSouthWest().lng(),
				'csrfmiddlewaretoken': '{{ csrf_token }}'
			}
			
			$.ajax({
				url: "{% url 'birds:get_map_points' %}",
				data: postData,
				type: "POST",
				dataType: "json",
				success: function(data) {
					map.data.forEach(function(feature){map.data.remove(feature)});
					
					features = [];
				
					for (var sighting in data) {
						features.push({
							"type": "Feature",
							"properties": { 'sighting_id': data[sighting].pk },
							"geometry": {
								"type": "Point",
								"coordinates": [
									data[sighting].fields.lng,
									data[sighting].fields.lat
								]
							}
						});
					}
					
					var j = {
						"type": "FeatureCollection",
						"features": features
					};
					
					map.data.addGeoJson(j);
					
					
				},
				error: function(data){
					console.log("got error in getting features from server.");
				}
			});
			
			bound_reset_activated = false;
			setTimeout(function(){
				bound_reset_activated = true;
			}, 2000);
		}
	
	})
	

	
	/*if (navigator.geolocation) {
		if (pos.lat == 0 && pos.lng == 0) {
			navigator.geolocation.getCurrentPosition(function(position) {
				pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				}
				map.setCenter(pos);
			}, function(err) {
				$('#msg').html("<p>ERROR(" + err.code + "): " + err.message + "</p>")
			})
		}
	} else {
		// Browser doesn't support Geolocation
		$('#msg').html("<p>Browser didn't allow geolocation.</p>")
		$('#warning-msg').slideToggle('slow');
	}*/

});

</script>



{% endblock %}
